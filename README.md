# MicroOS k3s Combustion

This is a set of combustion scripts for [openSUSE MicroOS](https://microos.opensuse.org/).
The goal is to get K3S installed during OS installation, with additional nodes automatically joining the cluster.

## How to use it?

There are 3 scripts: they are basically the same. Only the k3s-init.service used to install k3s changes.
- cluster-init.sh
- server.sh
- worker.sh

Each script installs a certain [K3S node type](https://docs.k3s.io/architecture#servers-and-agents).
cluster-init.sh should be the first to run as it install a server node with `--cluster-init` flag to initialie a new cluster with etcd.
server.sh for installing additional server nodes
worker.sh to install additional agent nodes


- **By default these scripts will setup bridged network interfaces**. Why? Because this is what I needed. To get standardinterfaces configured with DHCP you can simply remove `network_settings`.
- **The `USER_PASSWORD` and `ROOT_PASSWORD` variables expect a hash not an actual password**. See the example on [OpenSUSE Wiki](https://en.opensuse.org/Portal:MicroOS/Combustion#More_complex_configuration_example). Here's the command: `openssl passwd -6`
- KEYMAP variable is to set the Keyboard language. Check `localectl list-keymaps` if you need something else than us mapping

Below is an example of what the Variables at the top of the script might look like.
```plaintext
INSTALL_K3S_EXEC='server --cluster-init'
NODE_HOSTNAME='k3s-host-1'
NODE_IP_ADDR='192.168.1.11'
NODE_MASK='/24'
NODE_IP_GW='192.168.1.1'
USER='anomander_rake'

# Generate with: echo -n "complex_password" | openssl passwd -6 -stdin
USER_PASSWORD='$6$j7oFY74Vewb80fAy$FUFNTrl9kDftTbNd3oNuYxEbat508O5q.T05NoLUUebfjIpf6.kqpfp.vuXwb5pDgncVTCKGtz5x6Z1wk5xuL/'
ROOT_PASSWORD='$6$j7oFY74Vewb80fAy$FUFNTrl9kDftTbNd3oNuYxEbat508O5q.T05NoLUUebfjIpf6.kqpfp.vuXwb5pDgncVTCKGtz5x6Z1wk5xuL/'

# Generate with: ssh-keygen -t ed25519 -C "My SSH key for cluster access"
PUB_KEY='ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMhjbUktnOKubfTxXHrmn7Z1VCp1TH8eI0mPx4YbHLhz My SSH key for cluster access'
KEYMAP='gb'

# For additional Server/Agent you will also need the K3S token generated by the first master node, required to join the cluster.
# Once the first node is installed fetch it from /var/lib/rancher/k3s/server/node-token
K3S_TOKEN='K10xxxxxxxxxxxxxxxxxf2fb787a1c0dc0b74995fccc2e1911df4911d4a4189ec59::server:c233d93fe7e0b51e13e18826536a910d'
# You also need to specify an IP to reach the Kube API (the first node you installed)
K3S_API_HOST="192.168.1.11"
```

Note that once the combustion script has ran, the firstbootreboot service will reboot the node. This is needed to trigger SELinux relabbeling. Trying to instal k3s on the first boot will fail, [unless SELinux is specifically disabled](https://docs.k3s.io/advanced#selinux-support). \
For a reason I ignore, this does not seem to be required in VMs.


### Prepare USB Drive 

Follow the instructions on [OpenSUSE Wiki](https://en.opensuse.org/Portal:MicroOS/Combustion#Simple_example_formatting_USB_Drive_and_Adding_Config).

Make sure to copy the appropriate combustion sript on the destination USB drive as `script`. \
e.g: `cp combustion/cluster-init.sh /mnt/combustion/script`


## Sources
[OpenSuse Wiki, providing scripts](https://en.opensuse.org/SDB:K3s_cluster_deployment_on_MicroOS)
[Richard Brown's Blog](https://rootco.de/2020-12-09-microos-pi-network-monitor/)
